name: "Conventional Commits Validation"

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-commits:
    name: Validate Conventional Commits
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Validate commit messages
      run: |
        # Get commits in this PR
        git fetch origin main
        COMMITS=$(git log origin/main..HEAD --oneline)
        
        if [ -z "$COMMITS" ]; then
          echo "No commits found in this PR"
          exit 0
        fi
        
        echo "üìã Validating commit messages in this PR:"
        echo "$COMMITS"
        echo ""
        
        # Conventional commit pattern
        PATTERN="^[a-f0-9]+ (feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: .+"
        
        INVALID_COMMITS=""
        VALID_COUNT=0
        TOTAL_COUNT=0
        
        while IFS= read -r commit; do
          if [ -n "$commit" ]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            if echo "$commit" | grep -qE "$PATTERN"; then
              echo "‚úÖ $commit"
              VALID_COUNT=$((VALID_COUNT + 1))
            else
              echo "‚ùå $commit"
              INVALID_COMMITS="$INVALID_COMMITS\n- $commit"
            fi
          fi
        done <<< "$COMMITS"
        
        echo ""
        echo "üìä Validation Summary:"
        echo "Valid commits: $VALID_COUNT/$TOTAL_COUNT"
        
        if [ $VALID_COUNT -eq $TOTAL_COUNT ]; then
          echo "üéâ All commits follow conventional commit format!"
        else
          echo "‚ö†Ô∏è Some commits don't follow conventional commit format"
          echo ""
          echo "Invalid commits:$INVALID_COMMITS"
          echo ""
          echo "üìö Conventional Commit Format:"
          echo "type(scope): description"
          echo ""
          echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
          echo "Example: feat(auth): add user authentication"
          echo "Example: fix: resolve memory leak in parser"
          echo "Example: docs: update API documentation"
          
          # Don't fail the check, just warn
          echo ""
          echo "‚ÑπÔ∏è This is a warning - commits will still be accepted"
        fi

    - name: Comment on PR with validation results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const { execSync } = require('child_process');
          
          try {
            // Get validation results from previous step
            const commits = execSync('git log origin/main..HEAD --oneline', { encoding: 'utf8' }).trim();
            
            if (!commits) {
              return;
            }
            
            const commitLines = commits.split('\n').filter(line => line.trim());
            const pattern = /^[a-f0-9]+ (feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: .+/;
            
            let validCount = 0;
            let invalidCommits = [];
            
            commitLines.forEach(commit => {
              if (pattern.test(commit)) {
                validCount++;
              } else {
                invalidCommits.push(commit);
              }
            });
            
            const totalCount = commitLines.length;
            const allValid = validCount === totalCount;
            
            let comment = `## üìù Conventional Commits Validation\n\n`;
            
            if (allValid) {
              comment += `‚úÖ **All ${totalCount} commits follow conventional commit format!**\n\n`;
              comment += `This will help with automated changelog generation and semantic versioning.\n`;
            } else {
              comment += `‚ö†Ô∏è **${totalCount - validCount} out of ${totalCount} commits don't follow conventional commit format**\n\n`;
              comment += `### Invalid Commits:\n`;
              invalidCommits.forEach(commit => {
                comment += `- \`${commit}\`\n`;
              });
              comment += `\n### Conventional Commit Format:\n`;
              comment += `\`type(scope): description\`\n\n`;
              comment += `**Types:** feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert\n\n`;
              comment += `**Examples:**\n`;
              comment += `- \`feat(auth): add user authentication\`\n`;
              comment += `- \`fix: resolve memory leak in parser\`\n`;
              comment += `- \`docs: update API documentation\`\n\n`;
              comment += `*Note: This is informational - your PR will still be accepted.*`;
            }
            
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('Conventional Commits Validation')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
          } catch (error) {
            console.log('Error in commit validation:', error.message);
          }